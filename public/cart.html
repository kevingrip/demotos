<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="./css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <title>Carrito</title>
</head>

<body>
  <div id="products"></div>

  <script>
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    console.log("Carrito:", cart);

    const url = `/api/productos`;

    fetch(url)
      .then((response) => response.json())
      .then((products) => {
        const page = document.getElementById("products");
        const divPage = document.createElement("div");

        // NAVBAR
        const header = document.createElement("header");
        header.style.backgroundColor = "black";

        const nav = document.createElement("nav");
        const navList = document.createElement("ul");
        navList.style.listStyle = "none";
        navList.classList.add("navList");

        const createNavBarItem = (titulo, link) => {
          const navItem = document.createElement("li");
          const item = document.createElement("a");
          item.textContent = titulo;
          item.href = link;
          item.classList.add("itemNav");
          navItem.appendChild(item);
          navList.appendChild(navItem);
          nav.appendChild(navList);
          header.appendChild(nav);
          page.appendChild(header);
        };

        createNavBarItem("Inicio", "/inicio.html");

        const inputBuscador = document.createElement("input");
        inputBuscador.type = "text";
        inputBuscador.placeholder = "    Buscar producto...";
        inputBuscador.classList.add("inputBuscador");
        navList.appendChild(inputBuscador);

        inputBuscador.addEventListener("keydown", async (e) => {
          if (e.key === "Enter") {
            const texto = e.target.value.trim();
            window.location.href = `/productos.html?title=${texto}`;
          }
        });

        const navItemCart = document.createElement('li')
        const itemCart = document.createElement('a')
        const imgCart = document.createElement('img')
        imgCart.classList.add('imgCart')
        imgCart.src = './img/cart.png'
        imgCart.alt = 'carrito'
        itemCart.href = '/cart.html'
        itemCart.appendChild(imgCart)
        itemCart.classList.add('itemNav')
        navItemCart.appendChild(itemCart)
        navList.appendChild(navItemCart)
        nav.appendChild(navList)
        header.appendChild(nav)
        page.appendChild(header)

        // --- CONTENIDO PRINCIPAL ---
        const divGeneral = document.createElement("div");
        const divResumenTotal = document.createElement("div");

        const precioArg = (precio) => {
          return precio.toLocaleString("es-AR", {
            style: "currency",
            currency: "ARS",
            minimumFractionDigits: 2,
          });
        };

        const subtotalGeneral = document.createElement("p");
        subtotalGeneral.classList.add("subtotalResumenTotal");

        function recalcularSubtotalGeneral() {
          const nuevoSubtotal = cart.reduce((acc, item) => {
            const producto = products.find((p) => p.codigo === item.codigo);
            return acc + producto.precio * item.cantidad;
          }, 0);
          subtotalGeneral.textContent = `Subtotal: ${precioArg(nuevoSubtotal)}`;
        }

        cart.forEach((element) => {
          const findProduct = products.find((item) => item.codigo === element.codigo);

          let cant = element.cantidad;
          let precioProduct = precioArg(findProduct.precio * cant);

          const divResumenVenta = document.createElement("div");
          divResumenVenta.classList.add("divResumenVentaCart");

          // IMAGEN
          const divImagen = document.createElement("div");
          const img = document.createElement("img");
          img.src = `/uploads/${findProduct.imagen}`;
          img.alt = findProduct.title;
          img.classList.add("miniImgCart");
          divImagen.appendChild(img);

          // TITULO
          const divTitle = document.createElement("div");
          const title = document.createElement("p");
          title.textContent = findProduct.title;
          title.classList.add("titleCart");
          divTitle.classList.add("itemResumen");
          divTitle.appendChild(title);

          // CANTIDAD + BOTONES
          const divCantidad = document.createElement("div");
          const buttonCantRest = document.createElement("button");
          const buttonCantSum = document.createElement("button");
          const cantidad = document.createElement("p");

          cantidad.textContent = cant;
          cantidad.classList.add("cant");
          buttonCantRest.classList.add("buttonCant");
          buttonCantSum.classList.add("buttonCant");
          buttonCantRest.textContent = "−";
          buttonCantSum.textContent = "+";

          divCantidad.appendChild(buttonCantRest);
          divCantidad.appendChild(cantidad);
          divCantidad.appendChild(buttonCantSum);
          divCantidad.classList.add("divCantidad", "itemResumen");

          // PRECIO UNITARIO
          const divPrecioUnit = document.createElement("div");
          const precioUnit = document.createElement("p");
          precioUnit.textContent = precioArg(findProduct.precio);
          divPrecioUnit.classList.add("itemResumen", "centrar");
          divPrecioUnit.appendChild(precioUnit);

          // SUBTOTAL INDIVIDUAL
          const divSubtotal = document.createElement("div");
          const subtotalTexto = document.createElement("p");
          subtotalTexto.textContent = precioProduct;
          divSubtotal.classList.add("itemResumen", "centrar");
          divSubtotal.appendChild(subtotalTexto);

          // BORRAR ITEM
          const deleteItem = document.createElement("button");
          deleteItem.classList.add("deleteItem");
          deleteItem.textContent = "X";

          // Agregamos todo
          divResumenVenta.appendChild(divImagen);
          divResumenVenta.appendChild(divTitle);
          divResumenVenta.appendChild(divCantidad);
          divResumenVenta.appendChild(divPrecioUnit);
          divResumenVenta.appendChild(divSubtotal);
          divResumenVenta.appendChild(deleteItem);

          // BOTONES + y − funcionales
          buttonCantSum.addEventListener("click", () => {
            cant += 1;
            cantidad.textContent = cant;
            element.cantidad = cant;
            subtotalTexto.textContent = precioArg(findProduct.precio * cant);
            localStorage.setItem("cart", JSON.stringify(cart));
            recalcularSubtotalGeneral();
          });

          buttonCantRest.addEventListener("click", () => {
            if (cant > 1) {
              cant -= 1;
              cantidad.textContent = cant;
              element.cantidad = cant;
              subtotalTexto.textContent = precioArg(findProduct.precio * cant);
              localStorage.setItem("cart", JSON.stringify(cart));
              recalcularSubtotalGeneral();
            }
          });

          deleteItem.addEventListener("click", () => {
            const index = cart.findIndex((item) => item.codigo === element.codigo);
            if (index !== -1) {
              cart.splice(index, 1);
              localStorage.setItem("cart", JSON.stringify(cart));
              divResumenVenta.remove();
              recalcularSubtotalGeneral();
            }

            if (cart.length === 0) {
              divPage.remove();
              const emptyCart = document.createElement("div");
              const title = document.createElement("p");
              title.textContent = "¡TU CARRITO ESTÁ VACÍO!";
              title.classList.add("emptyCartTitle");
              emptyCart.classList.add("emptyCart");
              emptyCart.appendChild(title);
              page.appendChild(emptyCart);
            }
          });

          divGeneral.classList.add("divGeneralCart");
          divGeneral.appendChild(divResumenVenta);
        });

        if (cart.length > 0) {
          const title = document.createElement("p");
          title.textContent = "Resumen de mi Compra";
          title.classList.add("titleResumenTotal");

          divResumenTotal.appendChild(title);
          divResumenTotal.appendChild(subtotalGeneral);
          divResumenTotal.classList.add("divResumenTotal");

          const vaciar = document.createElement("button");
          vaciar.textContent = "Vaciar el Carrito";
          vaciar.addEventListener("click", () => {
            localStorage.removeItem("cart");
            window.location.reload();
          });
          divResumenTotal.appendChild(vaciar);

          divPage.appendChild(divGeneral);
          divPage.appendChild(divResumenTotal);
          divPage.classList.add("displayRow");

          page.appendChild(divPage);
        } else {
          const emptyCart = document.createElement("div");
          const title = document.createElement("p");
          title.textContent = "¡TU CARRITO ESTÁ VACÍO!";
          title.classList.add("emptyCartTitle");
          emptyCart.classList.add("emptyCart");
          emptyCart.appendChild(title);
          page.appendChild(emptyCart);
        }

        recalcularSubtotalGeneral();
      });
  </script>
</body>

</html>