<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="./css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="/components/nav.js"></script>
  <script src="/components/buttonAgregarCarrito.js"></script>
  <title>Carrito</title>
</head>

<body>
  <div id="products"></div>

  <script>
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    console.log("Carrito:", cart);

    const url = `/api/productos`;
    let nav2
    fetch(url)
      .then((response) => response.json())
      .then((products) => {
        const page = document.getElementById("products");
        // NAVBAR
        const header = document.createElement("header");
        const nav1 = getNav1()
        nav2 = getNav2()
        header.appendChild(nav1)
        if (cart.length>0){
          header.appendChild(nav2)
        }
        

        page.appendChild(header)

        // --- CONTENIDO PRINCIPAL ---
        const divGeneral = document.createElement("div");

        const divItemsCart = document.createElement("div");
        const divResumenTotal = document.createElement("div");
        const precioArg = (precio) => {
          return precio.toLocaleString("es-AR", {
            style: "currency",
            currency: "ARS",
            minimumFractionDigits: 2,
          });
        };

        const subtotalGeneral = document.createElement("p");
        subtotalGeneral.classList.add("subtotalResumenTotal");

        function recalcularSubtotalGeneral() {
          const nuevoSubtotal = cart.reduce((acc, item) => {
            const producto = products.find((p) => p.codigo === item.codigo);
            return acc + producto.precio * item.cantidad;
          }, 0);
          subtotalGeneral.textContent = `Subtotal: ${precioArg(nuevoSubtotal)}`;
        }

        const divTitlesCart = document.createElement('div');
        divTitlesCart.classList.add('displayRow', 'marginBodyCart');

        const titulos = ["Producto", "Detalle", "Cantidad", "Precio Unitario", "Subtotal", "Eliminar"];

        titulos.forEach(texto => {
          const div = document.createElement('div');
          div.textContent = texto;
          div.classList.add('itemResumen', 'titlesCart');
          divTitlesCart.appendChild(div);
        });

        divItemsCart.appendChild(divTitlesCart)

        cart.forEach((element) => {
          const findProduct = products.find((item) => item.codigo === element.codigo);

          let cant = element.cantidad;
          let precioProduct = precioArg(findProduct.precio * cant);

          const divResumenVenta = document.createElement("div");
          divResumenVenta.classList.add("divResumenVentaCart");

          // IMAGEN
          const divImagen = document.createElement("div");
          divImagen.classList.add("itemResumen");  // <-- agregar aquí
          const img = document.createElement("img");
          img.src = `/uploads/${findProduct.imagen}`;
          img.alt = findProduct.title;
          img.classList.add("miniImgCart");
          divImagen.appendChild(img);

          // TITULO
          const divTitle = document.createElement("div");
          const title = document.createElement("p");
          title.textContent = findProduct.title;
          title.classList.add("titleCart");
          divTitle.classList.add("itemResumen");
          divTitle.appendChild(title);

          // CANTIDAD + BOTONES
          const divCantidad = document.createElement("div");
          const buttonCantRest = document.createElement("button");
          const buttonCantSum = document.createElement("button");
          const cantidad = document.createElement("p");

          cantidad.textContent = cant;
          cantidad.classList.add("cant");
          buttonCantRest.classList.add("buttonCant");
          buttonCantSum.classList.add("buttonCant");
          buttonCantRest.textContent = "−";
          buttonCantSum.textContent = "+";

          divCantidad.appendChild(buttonCantRest);
          divCantidad.appendChild(cantidad);
          divCantidad.appendChild(buttonCantSum);
          divCantidad.classList.add("divCantidad", "itemResumen");

          // PRECIO UNITARIO
          const divPrecioUnit = document.createElement("div");
          const precioUnit = document.createElement("p");
          precioUnit.textContent = precioArg(findProduct.precio);
          divPrecioUnit.classList.add("itemResumen", "centrar");
          divPrecioUnit.appendChild(precioUnit);

          // SUBTOTAL INDIVIDUAL
          const divSubtotal = document.createElement("div");
          const subtotalTexto = document.createElement("p");
          subtotalTexto.textContent = precioProduct;
          divSubtotal.classList.add("itemResumen", "centrar");
          divSubtotal.appendChild(subtotalTexto);

          // BORRAR ITEM
          const divDelete = document.createElement("div");
          divDelete.classList.add("itemResumen");
          const deleteItem = document.createElement("button");
          deleteItem.classList.add("deleteItem");
          deleteItem.textContent = "X";
          divDelete.appendChild(deleteItem);

          // Agregamos todo
          divResumenVenta.appendChild(divImagen);
          divResumenVenta.appendChild(divTitle);
          divResumenVenta.appendChild(divCantidad);
          divResumenVenta.appendChild(divPrecioUnit);
          divResumenVenta.appendChild(divSubtotal);
          divResumenVenta.appendChild(divDelete);

          // BOTONES + y − funcionales
          buttonCantSum.addEventListener("click", () => {
            cant += 1;
            cantidad.textContent = cant;
            element.cantidad = cant;
            subtotalTexto.textContent = precioArg(findProduct.precio * cant);
            localStorage.setItem("cart", JSON.stringify(cart));
            recalcularSubtotalGeneral();
            actualizarContadorCarrito()
          });

          buttonCantRest.addEventListener("click", () => {
            if (cant > 1) {
              cant -= 1;
              cantidad.textContent = cant;
              element.cantidad = cant;
              subtotalTexto.textContent = precioArg(findProduct.precio * cant);
              localStorage.setItem("cart", JSON.stringify(cart));
              recalcularSubtotalGeneral();
              actualizarContadorCarrito()
            }
          });

          deleteItem.addEventListener("click", () => {
            const index = cart.findIndex((item) => item.codigo === element.codigo);
            if (index !== -1) {
              cart.splice(index, 1);
              localStorage.setItem("cart", JSON.stringify(cart));
              divResumenVenta.remove();
              recalcularSubtotalGeneral();
            }

            if (cart.length === 0) {
              divGeneral.remove();
              const emptyCart = document.createElement("div");
              const title = document.createElement("p");
              title.textContent = "¡TU CARRITO ESTÁ VACÍO!";
              title.classList.add("emptyCartTitle");
              emptyCart.classList.add("emptyCart");
              emptyCart.appendChild(title);
              page.appendChild(emptyCart);
            }
          });
          divItemsCart.appendChild(divResumenVenta);
        });

        if (cart.length > 0) {
          const title = document.createElement("p");

          divResumenTotal.appendChild(subtotalGeneral);
          divResumenTotal.classList.add("divResumenTotalCart");

          const vaciar = document.createElement("button");
          vaciar.textContent = "Vaciar el Carrito";
          vaciar.classList.add('btn', 'colorVaciar')
          vaciar.addEventListener("click", () => {
            localStorage.removeItem("cart");
            window.location.reload();
          });
          divResumenTotal.appendChild(vaciar);

          const nextPage = document.createElement("button");
          nextPage.textContent = "Avanzar";
          nextPage.classList.add('btn', 'nextPage')
          nextPage.addEventListener("click", () => {
            
            window.location.href='/productos.html';
          });
          divResumenTotal.appendChild(nextPage);


          divGeneral.appendChild(divItemsCart);
          divGeneral.appendChild(divResumenTotal);
          divGeneral.classList.add("displayColumn", 'divGeneral');

          page.appendChild(divGeneral);
        } else {
          const emptyCart = document.createElement("div");
          const title = document.createElement("p");
          title.textContent = "¡TU CARRITO ESTÁ VACÍO!";
          title.classList.add("emptyCartTitle");
          emptyCart.classList.add("emptyCart");
          emptyCart.appendChild(title);

          const buttonProduct = document.createElement("button");
          buttonProduct.textContent = "Ir a Productos";
          buttonProduct.classList.add('btn', 'nextPage')
          buttonProduct.addEventListener("click", () => {
            
            window.location.href='/productos.html';
          });
          emptyCart.appendChild(buttonProduct);
          page.appendChild(emptyCart);
        }

        recalcularSubtotalGeneral();
      });
  </script>
</body>

</html>