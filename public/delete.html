<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <title>Document</title>
</head>

<body>

    <div id="products"></div>

    <script>

        const params = new URLSearchParams(window.location.search);
        const family = params.get('family');
        const title = params.get('title')?.toLowerCase();

        let url = `/api/productos`

        if (family) {
            url += `?family=${family}`
        }
        if (title) {
            url += `?title=${title}`
        }


        fetch(url)
            .then(response => response.json())
            .then(products => {

                const page = document.getElementById('products')
                const allProducts = document.createElement('div')
                const buscador = document.createElement('div')

                const header = document.createElement('header')
                header.style.backgroundColor = 'black'

                const nav = document.createElement('nav')

                const navList = document.createElement('ul')
                navList.style.listStyle = 'none'
                navList.classList.add('navList')

                const createNavBarItem = (titulo, link) => {
                    const navItem = document.createElement('li')
                    const item = document.createElement('a')
                    item.textContent = titulo
                    item.href = link
                    item.classList.add('itemNav')
                    navItem.appendChild(item)
                    navList.appendChild(navItem)
                    nav.appendChild(navList)
                    header.appendChild(nav)
                    page.appendChild(header)
                }

                createNavBarItem('Inicio', '/inicio.html')
                const inputBuscador = document.createElement('input')
                inputBuscador.type = 'text'
                inputBuscador.placeholder = '    Buscar producto...'
                inputBuscador.classList.add('inputBuscador')
                navList.appendChild(inputBuscador)

                createNavBarItem('Carrito', '/cart.html')

                inputBuscador.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const texto = e.target.value.trim()

                        try {
                            window.location.href = `/productos.html?title=${texto}`

                        } catch (error) {
                            console.error(error)
                            divProductPadre.innerHTML = `<p style="text-align:center">No se encontraron productos</p>`
                        }
                    }
                })

                const divPag = document.createElement('div')
                const divTextPag = document.createElement('a')
                divTextPag.textContent = 'Productos'
                divTextPag.href = `/productos.html`
                divTextPag.classList.add('divTextPag')
                divPag.classList.add('divPag')
                divTextPag.classList.add('divTextPag')
                divPag.appendChild(divTextPag)

                let divProductPadre = document.createElement('div')

                products.forEach(element => {
                    let cant = 1
                    const precioProduct = (element.precio).toLocaleString('es-AR', {
                        style: 'currency',
                        currency: 'ARS',
                        minimumFractionDigits: 2
                    })

                    const mayusElement = element.title.charAt(0).toUpperCase() + element.title.slice(1);

                    const div = document.createElement('div')
                    const divData = document.createElement('div')
                    const img = document.createElement('img')
                    const divImagen = document.createElement('a')
                    const divTitle = document.createElement('a')
                    const title = document.createElement('h3')
                    const description = document.createElement('p')
                    const precio = document.createElement('h4')

                    divTitle.appendChild(title)
                    divImagen.href = `item.html?codigo=${element.codigo}`
                    divTitle.href = `item.html?codigo=${element.codigo}`
                    divTitle.classList.add('divTitle')

                    title.classList.add('tituloProducto')
                    img.src = `/uploads/${element.imagen}`
                    img.alt = element.title;
                    img.classList.add('imgProduct')
                    title.textContent = mayusElement
                    description.textContent = element.description
                    precio.textContent = precioProduct
                    const buttonDelete = document.createElement('button')
                    const divCompra = document.createElement('div')
                    const divCarrito = document.createElement('div')

                    divCarrito.appendChild(buttonDelete)
                    divCarrito.classList.add('divCarrito')
                    divCompra.appendChild(divCarrito)
                    divCompra.classList.add('divCompra')
                    divImagen.classList.add('subBloqueProduct')
                    divData.classList.add('subBloqueProduct')
                    divImagen.appendChild(img)
                    divData.appendChild(divTitle)
                    // divData.appendChild(description)
                    precio.classList.add('precioPageProducto')
                    divData.appendChild(precio)
                    divData.appendChild(divCompra)
                    div.appendChild(divImagen)
                    div.appendChild(divData)
                    title.classList.add('marginProduct')
                    description.classList.add('marginProduct')
                    precio.classList.add('marginProduct')
                    div.classList.add('bloquePageProduct')
                    divProductPadre.appendChild(div)
                    buttonDelete.textContent = 'ELIMINAR'
                    buttonDelete.addEventListener('click', async () => {
                        const codigo = element.codigo
                        try {
                            const respuesta = await fetch(`/api/delete/${codigo}`, {
                                method: 'DELETE'
                            });
                            div.remove()

                            if (!respuesta.ok) {
                                throw new Error('Error al eliminar el producto');
                            }

                            const resultado = await respuesta.json();
                            console.log(resultado.mensaje);

                        } catch (error) {
                            console.error(error.message);
                        }
                    })

                });

                divProductPadre.classList.add('contenedorProducts')

                page.appendChild(divPag)

                allProducts.appendChild(divProductPadre)

                const buttonCategoria = document.createElement('button')
                const menuCategorias = document.createElement('div')
                const ulCategorias = document.createElement('ul')
                menuCategorias.classList.add('menuCategorias')
                menuCategorias.style.display = 'none' // Oculto inicialmente

                fetch(`/api/productos`)
                    .then(response => response.json())
                    .then(prod => {
                        const categories = [...new Set(prod.map(element => element.familia))];
                        categories.forEach(element => {
                            const mayusElement = element.charAt(0).toUpperCase() + element.slice(1);

                            ulCategorias.innerHTML += `<li><a href="/productos.html?family=${element}">${mayusElement}</a></li>`

                        }
                        )
                    })


                menuCategorias.appendChild(ulCategorias)


                buttonCategoria.textContent = "CATEGORIAS >"
                buttonCategoria.classList.add('hamburger-btn')

                const divCategorias = document.createElement('div')

                divCategorias.appendChild(buttonCategoria)
                divCategorias.appendChild(menuCategorias)
                divCategorias.classList.add('divCategorias')

                buscador.appendChild(divCategorias)


                buttonCategoria.addEventListener('click', () => {
                    if (menuCategorias.style.display === 'none') {
                        menuCategorias.style.display = 'block'
                    } else {
                        menuCategorias.style.display = 'none'
                    }
                })

                buscador.classList.add('buscador')

                const unirPages = document.createElement('div')
                unirPages.classList.add('unirPages')
                unirPages.appendChild(buscador)
                unirPages.appendChild(allProducts)
                page.appendChild(unirPages)

            })



    </script>
</body>

</html>